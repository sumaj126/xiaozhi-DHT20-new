# 服务器端TTS问题诊断指南

## 当前状态确认

✅ 状态机问题已解决 - 状态转换正常
✅ STT消息发送成功 - 服务器收到请求
❌ TTS音频未返回 - 核心问题仍在

## 服务器端检查清单

### 1. 服务器日志检查
在服务器端查找以下关键字：
```
Session ID: 5e9a0da7
STT message received: 提醒时间到了，时间到了
TTS processing for reminder
TTS audio generation error
```

### 2. TTS服务状态验证
检查服务器上的TTS服务：
- 是否正常运行
- API密钥是否有效
- 配额是否充足
- 网络连接是否正常

### 3. 协议格式验证
确认STT消息格式是否符合服务器期望：
```json
{
  "session_id": "5e9a0da7",
  "type": "stt", 
  "text": "提醒时间到了，时间到了"
}
```

### 4. 网络通信监控
使用抓包工具监控：
- MQTT/WebSocket连接状态
- 消息传输完整性
- 响应时间统计

## 可能的解决方案

### 方案1：服务器配置检查
联系服务器管理员确认：
- TTS服务是否针对提醒功能启用
- 是否有特殊的路由规则
- 日志级别是否足够详细

### 方案2：消息格式调整
尝试修改STT消息格式：
```cpp
// 可能需要添加额外字段
std::string stt_msg = "{\"session_id\":\"" + protocol_->session_id() + 
                      "\",\"type\":\"stt\",\"text\":\"" + tts_text + 
                      "\",\"source\":\"reminder\",\"priority\":\"high\"}";
```

### 方案3：备用TTS方案
考虑实现本地TTS作为备选：
- 使用ESP32-S3的硬件TTS能力
- 集成轻量级TTS引擎
- 预录制常用提醒语音

## 测试验证步骤

1. **简单TTS测试**：先测试普通对话TTS是否正常
2. **相同文本测试**：用同样的文本测试其他场景
3. **最小化测试**：发送最简单的STT消息测试
4. **日志对比**：对比成功和失败情况的服务器日志

## 临时解决方案

如果短期内无法解决服务器问题，可以：
1. 延长超时时间到60秒
2. 添加重试机制
3. 使用本地铃声替代TTS
4. 显示文字提醒作为补充

## 紧急联系方式

如果这是生产环境问题，建议：
1. 立即联系服务器技术支持
2. 提供完整的会话ID和时间戳
3. 准备详细的日志信息
4. 建立紧急响应通道